{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap_ru.css' %}">

<body>
  <main class="container mb5">
    <h1>Microphone Test</h1>
    <hr>
    <p>Please test your microphone before continuing.</p>

    {% include "recording_controls.html" with playback=True %}
    <div id="volume-container" style="margin-top:10px;">
      <div style="width:200px; height:10px; background:#eee;">
        <div id="volume-bar" style="height:10px; background:#4caf50; width:0;"></div>
      </div>
    </div>

    <form method="post" action="/?run={{ testrun.id }}">
      {% csrf_token %}
      <input type="hidden" name="stage" value="{{ stage.id|default_if_none:'' }}">
      <button class="btn btn-primary" type="submit">Next</button>
    </form>

    <div class="mb-3 text-center">
        <a class="flag-icon" href="?lang=en">
            <span class="fi fi-gb fis flag-icon" title="English"></span>
        </a>
        <a class="flag-icon" href="?lang=nl">
            <span class="fi fi-nl fis flag-icon" title="Nederlands"></span>
        </a>
        <div class="mt-4">
            <img src="https://cls.ru.nl/RU_logo.svg" alt="Radboud Universiteit" style="height: 2rem; margin-top: 1rem;" />
        </div>
    </div>
  </main>
</body>

<script>
let audioContext;
let analyser;
let source;
let volumeAnimation;
const volumeBar = document.getElementById('volume-bar');

function updateVolume() 
{
  if (analyser) {
    const dataArray = new Uint8Array(analyser.fftSize);
    analyser.getByteTimeDomainData(dataArray);
    let sum = 0;
    for (let i = 0; i < dataArray.length; i++) {
      sum += Math.abs(dataArray[i] - 128);
    }
    const average = sum / dataArray.length;
    volumeBar.style.width = Math.min(average * 10, 200) + 'px';
  }
  volumeAnimation = requestAnimationFrame(updateVolume);
}

async function startVolumeMeter() 
{
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  source = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 256;
  source.connect(analyser);
  updateVolume();
}

startVolumeMeter();
</script>
